# Anchor Account Reload Vulnerability (Token CPI Example)

This repository demonstrates a common Anchor pitfall involving
Cross-Program Invocations (CPIs) and stale account data.

The example uses a real CPI to the SPL Token program to show how
Anchor does NOT automatically refresh deserialized account structs
after a CPI that mutates account data.

This code is for educational and auditing purposes only.
It is not production-ready.

---

## The Core Problem

When Anchor deserializes an account into an `Account<T>` struct,
that struct becomes the program’s in-memory representation of the
account’s data.

If a CPI modifies that account’s data (for example, minting tokens
which updates `Mint.supply`), Anchor does NOT automatically update
the struct.

As a result, reading fields from the struct after the CPI returns
stale values.

---

## Why This Is Dangerous

Protocols often perform logic like:

- mint tokens
- read updated supply
- perform calculations or enforce invariants

If the supply is read from a stale struct, calculations may be
incorrect, potentially leading to broken accounting, invalid checks,
or exploitable logic.

---

## Demonstrated Example

This program performs:

1. A CPI to `anchor_spl::token::mint_to`
2. The CPI increases `Mint.supply` on-chain
3. The program reads `mint.supply` again
4. Without reload(), the value is unchanged

This behavior is counterintuitive and frequently missed by developers.

---

## Vulnerable Pattern

- Deserialize account at instruction entry
- Perform CPI that mutates account data
- Continue execution
- Read from stale `Account<T>` struct

---

## Correct Pattern

After any CPI that may mutate account data:

    account.reload()?;

This forces Anchor to re-deserialize `account_info.data` and
synchronize the struct with the actual on-chain state.

---

## Important Clarification

This issue applies to account data only.

Lamport balance changes are always read live from `AccountInfo`
and do not require reload().

---

## One-Line Rule

If a CPI can modify an account and you read it afterward, reload it.

---

## Disclaimer

This repository exists solely for educational and auditing purposes.
It intentionally focuses on clarity rather than production concerns.
Do not deploy this code as-is.
